req2ch = require '../mylibs/req2ch'
redismng = require '../mylibs/redismng'
redis = require 'redis'
client = redis.createClient()

exports.render = (req, res) ->
  client.get 'updateTime', (err, ret) ->
    now = new Date()
    millis = now.getMilliseconds()
    if ret? and millis - ret < 10000     # 本番では1時間
      console.log 'ret=' + ret + ' millis=' + millis
      res.render 'refresh', {
        title: '更新 - 時間制限中'
        body: 'データの更新は1時間に1回です。あと' + (3600000 - millis - ret)/1000 + '秒お待ちください。' 
      }
    else
      res.render 'refresh', {
        title: '更新中…'
        body: 'データの更新を開始しました。しばらく待ってから確認してください。'
      }
      client.set 'updateTime', millis, redis.print
      refresh()
      


refresh = () ->
  req2ch.threads (ary) ->
    return if ary.length <= 0
    ary.sort()
    console.log ary[0].dat
    req2ch.getDat ary[0].dat, (body, url) ->
      redismng.parse body
      now = new Date()
      millis = now.getMilliseconds()
    ,(err) -> console.log 'req2ch#getDat error'
  ,(err) -> console.log 'req2ch#threads error'
